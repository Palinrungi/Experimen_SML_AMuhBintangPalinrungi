name: CI MLflow - Credit Card Fraud Detection

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-train:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Setup Python 3.10
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      # Install MLflow
      - name: Install MLflow
        run: |
          python -m pip install --upgrade pip
          pip install mlflow
      
      # Run MLflow Project
      - name: Run MLflow Project
        run: |
          cd MLProject
          mlflow run . --env-manager=local
      
      # Upload artifacts to GitHub (SKILLED - 3 pts)
      - name: Upload Model Artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: mlflow-artifacts
          path: |
            MLProject/mlruns/
            MLProject/mlflow_artifacts/
          retention-days: 30
      
      # Create training summary
      - name: Create Training Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ MLflow Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Training Completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Artifacts:** Saved to GitHub Actions Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¬ **Experiment:** Credit Card Fraud Detection" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Author:** A. Muh. Bintang Palinrungi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Kriteria Terpenuhi (Skilled - 3 pts)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Workflow CI dengan GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ MLflow Project structure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Artifacts disimpan ke GitHub Repository" >> $GITHUB_STEP_SUMMARY
