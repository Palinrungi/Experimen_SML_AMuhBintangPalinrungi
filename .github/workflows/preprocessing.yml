name: Data Preprocessing Automation

on: 
  push:
    branches: 
      - main
      - master
    paths:
      - 'Credit Card Dataset_raw/**'
      - 'Preprocessing/automate_BintangPalinrungi.py'
  pull_request:
    branches: 
      - main
      - master
  workflow_dispatch:  # Manual trigger

jobs:
  preprocessing: 
    runs-on: ubuntu-latest
    
    steps: 
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Python 3.10
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with: 
          python-version: "3.10"
      
      # Install dependencies from requirements. txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Run preprocessing script
      - name: Run preprocessing automation
        run:  |
          cd Preprocessing
          python automate_BintangPalinrungi.py
        continue-on-error: false
      
      # Verify output files
      - name: Verify preprocessed data
        run: |
          echo "ðŸ“‚ Checking preprocessed data files..."
          ls -lh Preprocessing/CreditCard_Preprocessing/ || echo "Folder not found"
          if [ -f "Preprocessing/CreditCard_Preprocessing/train_data.csv" ]; then
            echo "âœ… train_data.csv found"
          else
            echo "âŒ train_data.csv NOT found"
          fi
          if [ -f "Preprocessing/CreditCard_Preprocessing/test_data.csv" ]; then
            echo "âœ… test_data.csv found"
          else
            echo "âŒ test_data.csv NOT found"
          fi
      
      # Upload preprocessed data as artifact
      - name: Upload preprocessed data
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: preprocessed-creditcard-data-${{ github.run_number }}
          path: |
            Preprocessing/CreditCard_Preprocessing/train_data.csv
            Preprocessing/CreditCard_Preprocessing/test_data.csv
            Preprocessing/CreditCard_Preprocessing/preprocessor.pkl
          retention-days: 30
      
      # Create summary
      - name: Create preprocessing summary
        if: success()
        run: |
          echo "## ðŸ“Š Preprocessing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Preprocessing completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Script:** automate_BintangPalinrungi.py" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Author:** A.  Muh.  Bintang Palinrungi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "- \`train_data.csv\` - Training dataset" >> $GITHUB_STEP_SUMMARY
          echo "- \`test_data.csv\` - Testing dataset" >> $GITHUB_STEP_SUMMARY
          echo "- \`preprocessor.pkl\` - Preprocessing pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Display dataset statistics
          if [ -f "Preprocessing/CreditCard_Preprocessing/train_data.csv" ]; then
            echo "### ðŸ“ˆ Dataset Statistics:" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF'
          import pandas as pd
          try:
              train = pd.read_csv('Preprocessing/CreditCard_Preprocessing/train_data.csv')
              test = pd.read_csv('Preprocessing/CreditCard_Preprocessing/test_data.csv')
              print(f"- Training samples: {len(train):,}")
              print(f"- Testing samples:  {len(test):,}")
              print(f"- Total features: {train.shape[1] - 1}")
              if 'is_fraud' in train.columns:
                  print(f"- Fraud cases (train): {train['is_fraud'].sum():,}")
                  print(f"- Fraud cases (test): {test['is_fraud'].sum():,}")
          except Exception as e:
              print(f"Error reading data: {e}")
          EOF
          fi
      
      # Optional: Commit preprocessed data back to repo
      - name: Commit preprocessed data
        if: github.event_name == 'push' && success()
        run: |
          git config --local user. email "github-actions[bot]@users. noreply.github.com"
          git config --local user. name "github-actions[bot]"
          git add Preprocessing/CreditCard_Preprocessing/*.csv Preprocessing/CreditCard_Preprocessing/*.pkl 2>/dev/null || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update:  Preprocessed data $(date +'%Y-%m-%d %H:%M:%S')" && git push) || echo "Nothing to commit"
